<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wookiee Online - FacturaciÃ³n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding-bottom: 50px; }
        
        /* HEADER Y DASHBOARD */
        .header-section { background: #2c3e50; color: white; padding: 20px 20px 60px 20px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .dash-card { background: white; color: #333; border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.1); height: 100%; display: flex; flex-direction: column; justify-content: center; }
        .dash-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #7f8c8d; font-weight: bold; margin-bottom: 5px; }
        .dash-value { font-size: 1.6rem; font-weight: 800; color: #2c3e50; }
        .text-money-green { color: #27ae60; }
        
        /* CONTENEDOR PRINCIPAL */
        .main-container { margin-top: -40px; padding: 0 15px; }
        .bg-glass { background: white; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); overflow: hidden; border: none; }
        
        /* TABLA */
        .table-responsive { max-height: 65vh; overflow-y: auto; }
        thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 5; }
        .low-stock-row { background-color: #fff0f0 !important; }
        
        /* IMAGENES */
        .img-preview { width: 50px; height: 50px; border-radius: 8px; background: #eee; object-fit: cover; border: 1px solid #ddd; cursor: pointer; transition: transform 0.2s; }
        .img-preview:hover { transform: scale(1.5); z-index: 10; border-color: #3498db; }
        .no-img { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: #eee; border-radius: 8px; color: #aaa; cursor: pointer; }

        /* INPUTS */
        .cell-input { border: 1px solid transparent; background: transparent; text-align: center; width: 100%; font-size: 0.95rem; padding: 4px; border-radius: 4px; }
        .cell-input:focus { background: white; border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        .font-price { color: #27ae60; font-weight: 600; width: 70px !important; }
        .font-cost { color: #c0392b; font-size: 0.85rem; width: 60px !important; }
        .font-stock { font-weight: bold; color: #2980b9; width: 50px !important; }

        /* LOADER */
        #app-loader { position: fixed; top:0; left:0; width:100vw; height:100vh; background: rgba(255,255,255,0.98); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }

        /* --- ESTILOS IMPRESIÃ“N (NOTA DE ENTREGA) --- */
        #invoice-template { display: none; }
        
        @media print {
            body * { visibility: hidden; }
            #invoice-template, #invoice-template * { visibility: visible; }
            #invoice-template {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                padding: 20px;
            }
            .header-section, .main-container, .modal, .toastify { display: none !important; }
        }

        .invoice-box {
            max-width: 800px;
            margin: auto;
            border: 1px solid #eee;
            padding: 30px;
            font-size: 16px;
            line-height: 24px;
            font-family: 'Helvetica Neue', 'Helvetica', Helvetica, Arial, sans-serif;
            color: #555;
        }
        .invoice-header { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .invoice-title { font-size: 24px; font-weight: bold; color: #333; }
        .invoice-details { text-align: right; font-size: 14px; }
    </style>
</head>
<body>

<div id="app-loader">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    <h5 class="mt-3 text-secondary">Conectando a la Nube...</h5>
</div>

<div id="invoice-template">
    <div class="invoice-box">
        <div class="invoice-header">
            <div>
                <div class="invoice-title">WookieeÂ®</div>
                <small>Equipos MÃ©dicos e Insumos</small><br>
                <small>Guayana, Venezuela</small><br>
                <small class="fw-bold">ðŸ“ž +58 412-0314772</small>
            </div>
            <div class="invoice-details">
                <strong>NOTA DE ENTREGA</strong><br>
                Fecha: <span id="invDate"></span><br>
                NÂ° Control: <span id="invId" class="text-danger fw-bold"></span>
            </div>
        </div>

        <div class="mb-4">
            <strong>Cliente:</strong> <span id="invClient"></span><br>
            <strong>Documento/RIF:</strong> <span id="invDoc"></span>
        </div>

        <table class="table table-bordered">
            <thead class="table-light">
                <tr>
                    <th>DescripciÃ³n</th>
                    <th class="text-center">Cant.</th>
                    <th class="text-end">Precio Unit.</th>
                    <th class="text-end">Total</th>
                </tr>
            </thead>
            <tbody id="invItems"></tbody>
            <tfoot>
                <tr>
                    <td colspan="3" class="text-end fw-bold">TOTAL A PAGAR:</td>
                    <td class="text-end fw-bold fs-5" id="invTotal"></td>
                </tr>
            </tfoot>
        </table>
        
        <div class="mt-5 text-center text-muted small">
            <p>Â¡Gracias por su compra!</p>
            <p>__________________________<br>Recibido Conforme</p>
        </div>
    </div>
</div>

<div class="header-section">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="mb-0 fw-bold"><i class="bi bi-cloud-check"></i> Wookiee Online</h3>
            <small class="opacity-75">Sistema de GestiÃ³n</small>
        </div>
        <button class="btn btn-success fw-bold shadow-sm" onclick="saveData(false)">
            <i class="bi bi-save"></i> Guardar Cambios
        </button>
    </div>

    <div class="row g-3">
        <div class="col-4">
            <div class="dash-card">
                <div class="dash-label">InversiÃ³n (Costo)</div>
                <div class="dash-value" id="dashInvest">$0.00</div>
            </div>
        </div>
        <div class="col-4">
            <div class="dash-card">
                <div class="dash-label">Valor Venta</div>
                <div class="dash-value" id="dashValue">$0.00</div>
            </div>
        </div>
        <div class="col-4">
            <div class="dash-card">
                <div class="dash-label">Ingresos Totales</div>
                <div class="dash-value text-money-green" id="dashRevenue">$0.00</div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid main-container">
    <div class="card bg-glass">
        <div class="card-body p-0">
            
            <ul class="nav nav-tabs nav-justified mb-0" id="mainTabs" role="tablist">
                <li class="nav-item"><button class="nav-link active py-3 fw-bold" data-bs-toggle="tab" data-bs-target="#tab-stock">ðŸ“¦ Inventario</button></li>
                <li class="nav-item"><button class="nav-link py-3 fw-bold" data-bs-toggle="tab" data-bs-target="#tab-sales">ðŸ’° Ventas</button></li>
            </ul>

            <div class="tab-content p-3">
                <div class="tab-pane fade show active" id="tab-stock">
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                                <input type="text" id="searchInput" class="form-control border-start-0" placeholder="Buscar producto...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="catFilter" onchange="render()">
                                <option value="">Todas las CategorÃ­as</option>
                                <option value="PapelerÃ­a">PapelerÃ­a</option>
                                <option value="Cintas">Cintas</option>
                                <option value="Insumos">Insumos</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary w-100" onclick="newItem()">+ Nuevo Producto</button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle text-center mb-0">
                            <thead class="table-light text-secondary small text-uppercase">
                                <tr>
                                    <th width="60">Img</th>
                                    <th>Cat</th>
                                    <th class="text-start">Producto</th>
                                    <th>Var</th>
                                    <th>Costo</th>
                                    <th>Precio</th>
                                    <th>Stock</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                    
                    <div class="d-flex justify-content-end align-items-center mt-3 gap-2">
                        <button class="btn btn-sm btn-light border" onclick="pg(-1)">Anterior</button>
                        <span class="small fw-bold" id="pageInd">1</span>
                        <button class="btn btn-sm btn-light border" onclick="pg(1)">Siguiente</button>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-sales">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Historial de Transacciones</h5>
                        <button class="btn btn-outline-danger btn-sm" onclick="clearHistory()">Limpiar Historial</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped align-middle text-center small">
                            <thead class="table-dark">
                                <tr><th>Control</th><th>Fecha</th><th>Cliente</th><th>DescripciÃ³n</th><th>Total</th><th></th></tr>
                            </thead>
                            <tbody id="salesBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<input type="file" id="imgUpload" accept="image/*" style="display:none">

<div class="modal fade" id="sellModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-success text-white py-2"><h6 class="modal-title">Realizar Venta</h6></div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <h5 class="fw-bold mb-0" id="mProd"></h5>
                    <small class="text-muted" id="mVar"></small>
                </div>
                
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="form-floating">
                            <input type="number" class="form-control fw-bold text-center" id="mQty" value="1">
                            <label>Cantidad</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-floating">
                            <input type="number" class="form-control text-success fw-bold text-center" id="mPrice">
                            <label>Precio Unit ($)</label>
                        </div>
                    </div>
                </div>

                <hr>
                <small class="text-muted fw-bold mb-2 d-block">Datos para Nota de Entrega</small>
                <div class="form-floating mb-2">
                    <input type="text" class="form-control" id="mClientName" placeholder="Nombre del Cliente">
                    <label>Nombre del Cliente</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="mClientDoc" placeholder="CÃ©dula o RIF">
                    <label>CÃ©dula / RIF</label>
                </div>

                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary w-50" onclick="processSale(false)">Solo Guardar</button>
                    <button class="btn btn-success w-50" onclick="processSale(true)"><i class="bi bi-printer"></i> Guardar e Imprimir</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
    // ===============================================
    // 1. CONEXIÃ“N FIREBASE
    // ===============================================
    const firebaseConfig = {
        apiKey: "AIzaSyAO-IfNVWcz_DyjAQDs31i7dvCaIBEH8Rg",
        authDomain: "wookiee-inventario.firebaseapp.com",
        projectId: "wookiee-inventario",
        storageBucket: "wookiee-inventario.firebasestorage.app",
        messagingSenderId: "438310377986",
        appId: "1:438310377986:web:2e748049205e7d85d9e51b"
    };

    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
    } catch (e) { console.error(e); }

    // ===============================================
    // 2. VARIABLES
    // ===============================================
    let inventory = [], sales = [];
    let invoiceCounter = 0; // CONTADOR DE FACTURAS
    let page = 1, LIMIT = 8;
    let curImgIdx = -1, curSellIdx = -1;
    const sellModal = new bootstrap.Modal('#sellModal');

    function getBaseCatalog() {
        const gen = (c, n, p, count) => Array.from({length:count}, (_,i)=>({cat:c, name:n, var:`#${(i+1).toString().padStart(3,'0')}`, price:p, cost:(p*0.6).toFixed(2), stock:0, img:''}));
        return [
            ...gen("PapelerÃ­a", "Papel Base", 6, 5),
            {cat:"Insumos", name:"Producto Demo", var:"#001", price:10, cost:5, stock:10, img:""}
        ];
    }

    // ===============================================
    // 3. FUNCIONES DE RED
    // ===============================================

    function init() {
        db.collection("wookiee_db").doc("main_data").get().then((doc) => {
            if (doc.exists) {
                const d = doc.data();
                inventory = d.inventory || getBaseCatalog();
                sales = d.sales || [];
                // CARGAMOS EL CONTADOR (O empieza en 0 si no existe)
                invoiceCounter = d.lastInvoiceId || 0;
            } else {
                inventory = getBaseCatalog();
                saveData(true);
            }
            document.getElementById('app-loader').style.display = 'none';
            render();
            renderSales();
            calcStats();
        }).catch(e => {
            alert("Error conectando: " + e.message);
        });
    }

    function saveData(silent = false) {
        db.collection("wookiee_db").doc("main_data").set({
            inventory: inventory,
            sales: sales,
            lastInvoiceId: invoiceCounter, // GUARDAMOS EL CONTADOR
            lastUpdate: new Date().toISOString()
        }).then(() => {
            if(!silent) Toastify({text: "â˜ï¸ Guardado en Nube", duration: 2000, style: {background: "#27ae60"}}).showToast();
            calcStats();
        });
    }

    // ===============================================
    // 4. LÃ“GICA DE UI
    // ===============================================
    window.render = () => {
        const txt = document.getElementById('searchInput').value.toLowerCase();
        const cat = document.getElementById('catFilter').value;
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";

        const filtered = inventory.map((it, idx)=>({...it, _id:idx})).filter(i => 
            (i.name.toLowerCase().includes(txt) || i.var.toLowerCase().includes(txt)) && 
            (cat === "" || i.cat === cat)
        );

        const totalPages = Math.ceil(filtered.length / LIMIT) || 1;
        if(page > totalPages) page = 1;
        const start = (page - 1) * LIMIT;
        const list = filtered.slice(start, start + LIMIT);

        document.getElementById('pageInd').innerText = `${page} / ${totalPages}`;

        list.forEach(item => {
            let rowClass = parseInt(item.stock) <= 3 ? "low-stock-row" : "";
            let imgHtml = item.img 
                ? `<img src="${item.img}" class="img-preview" onclick="clkImg(${item._id})">` 
                : `<div class="no-img" onclick="clkImg(${item._id})"><i class="bi bi-camera"></i></div>`;

            tbody.innerHTML += `
                <tr class="${rowClass}">
                    <td>${imgHtml}</td>
                    <td class="text-muted small fw-bold text-uppercase">${item.cat.substring(0,3)}</td>
                    <td class="text-start fw-bold">${item.name}</td>
                    <td><input value="${item.var}" class="cell-input text-secondary" onchange="upd(${item._id},'var',this.value)"></td>
                    <td><input type="number" value="${item.cost}" class="cell-input font-cost" onchange="upd(${item._id},'cost',this.value)"></td>
                    <td><input type="number" value="${item.price}" class="cell-input font-price" onchange="upd(${item._id},'price',this.value)"></td>
                    <td>
                        <div class="d-flex align-items-center justify-content-center gap-1">
                            <i class="bi bi-dash-circle-fill text-secondary" style="cursor:pointer" onclick="stk(${item._id}, -1)"></i>
                            <input type="number" value="${item.stock}" class="cell-input font-stock" onchange="upd(${item._id},'stock',this.value)">
                            <i class="bi bi-plus-circle-fill text-primary" style="cursor:pointer" onclick="stk(${item._id}, 1)"></i>
                        </div>
                    </td>
                    <td><button class="btn btn-success btn-sm rounded-pill px-3" onclick="openSell(${item._id})">$</button></td>
                </tr>
            `;
        });
    };

    window.upd = (id, key, val) => {
        inventory[id][key] = (key === 'var') ? val : parseFloat(val) || 0;
        calcStats();
    };

    window.stk = (id, delta) => {
        let curr = parseFloat(inventory[id].stock) || 0;
        let next = curr + delta;
        if(next < 0) next = 0;
        inventory[id].stock = next;
        render();
        calcStats();
    };

    window.pg = (d) => { page += d; render(); };
    document.getElementById('searchInput').addEventListener('keyup', render);

    window.clkImg = (id) => { curImgIdx = id; document.getElementById('imgUpload').click(); };
    document.getElementById('imgUpload').onchange = (e) => {
        if(e.target.files[0]) {
            const r = new FileReader();
            r.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    const c = document.createElement('canvas');
                    const ctx = c.getContext('2d');
                    const S = 150; 
                    let w=img.width, h=img.height;
                    if(w>h){ if(w>S){h*=S/w;w=S;}} else {if(h>S){w*=S/h;h=S;}}
                    c.width=w; c.height=h;
                    ctx.drawImage(img,0,0,w,h);
                    inventory[curImgIdx].img = c.toDataURL('image/jpeg', 0.7);
                    saveData(true); 
                    render();
                };
                img.src = ev.target.result;
            };
            r.readAsDataURL(e.target.files[0]);
        }
    };

    // ===============================================
    // 5. VENTAS (LÃ“GICA MEJORADA)
    // ===============================================
    window.openSell = (id) => {
        curSellIdx = id;
        const i = inventory[id];
        document.getElementById('mProd').innerText = i.name;
        document.getElementById('mVar').innerText = i.var;
        document.getElementById('mPrice').value = i.price;
        document.getElementById('mQty').value = 1;
        document.getElementById('mClientName').value = "";
        document.getElementById('mClientDoc').value = "";
        sellModal.show();
    };

    window.processSale = (shouldPrint) => {
        const qty = parseFloat(document.getElementById('mQty').value);
        const price = parseFloat(document.getElementById('mPrice').value);
        const client = document.getElementById('mClientName').value || "Cliente General";
        const docId = document.getElementById('mClientDoc').value || "-";
        
        const item = inventory[curSellIdx];

        if(qty > 0) {
            item.stock = Math.max(0, (parseFloat(item.stock)||0) - qty);
            const total = qty * price;
            const profit = total - (qty * (parseFloat(item.cost)||0));

            // INCREMENTAMOS EL CONTADOR DE FACTURAS
            invoiceCounter++;
            const invoiceCode = String(invoiceCounter).padStart(6, '0'); // Ejem: 000001

            const saleRecord = {
                id: invoiceCode, // Guardamos el nÃºmero correlativo
                date: new Date().toLocaleString(),
                desc: `${item.name} (${item.var})`,
                client: client,
                qty: qty,
                priceUnit: price,
                total: total.toFixed(2),
                profit: profit.toFixed(2)
            };

            sales.unshift(saleRecord);
            sellModal.hide();
            
            saveData(); // Guarda el inventario Y el nuevo contador
            render();
            renderSales();

            if (shouldPrint) {
                printInvoice(saleRecord);
            }
        }
    };

    function printInvoice(sale) {
        document.getElementById('invDate').innerText = new Date().toLocaleDateString();
        // Usamos el ID correlativo
        document.getElementById('invId').innerText = sale.id; 
        document.getElementById('invClient').innerText = sale.client;
        document.getElementById('invDoc').innerText = document.getElementById('mClientDoc').value || "No indicado";
        
        document.getElementById('invItems').innerHTML = `
            <tr>
                <td>${sale.desc}</td>
                <td class="text-center">${sale.qty}</td>
                <td class="text-end">$${parseFloat(sale.priceUnit).toFixed(2)}</td>
                <td class="text-end">$${sale.total}</td>
            </tr>
        `;
        document.getElementById('invTotal').innerText = "$" + sale.total;

        setTimeout(() => {
            window.print();
        }, 500);
    }

    function renderSales() {
        let html = "";
        sales.slice(0, 50).forEach((s, i) => {
            html += `<tr>
                <td class="text-muted fw-bold">#${s.id || '---'}</td>
                <td><small>${s.date.split(',')[0]}</small></td>
                <td><small class="text-muted">${s.client || '-'}</small></td>
                <td>${s.desc}</td>
                <td class="text-success fw-bold">$${s.total}</td>
                <td><button class="btn-close" onclick="delSale(${i})"></button></td>
            </tr>`;
        });
        document.getElementById('salesBody').innerHTML = html;
    }

    window.delSale = (i) => { if(confirm("Â¿Borrar registro?")) { sales.splice(i,1); saveData(); renderSales(); } };
    window.clearHistory = () => { if(confirm("Â¿Borrar todo el historial?")) { sales=[]; saveData(); renderSales(); } };

    function calcStats() {
        let invest = 0, value = 0;
        inventory.forEach(i => {
            const s = parseFloat(i.stock) || 0;
            const c = parseFloat(i.cost) || 0;
            const p = parseFloat(i.price) || 0;
            invest += s * c;
            value += s * p;
        });
        let revenue = sales.reduce((acc, s) => acc + parseFloat(s.total||0), 0);
        document.getElementById('dashInvest').innerText = "$" + invest.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('dashValue').innerText = "$" + value.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('dashRevenue').innerText = "$" + revenue.toLocaleString(undefined, {minimumFractionDigits: 2});
    }

    window.newItem = () => {
        const n = prompt("Nombre del producto:");
        if(n) { inventory.unshift({cat:"Nuevo", name:n, var:"-", price:0, cost:0, stock:0, img:""}); render(); }
    };

    init();

</script>
</body>
</html>
